<!-- loioef0377f5e9d84ce3aeb43a7e4baa5fe4 -->

<link rel="stylesheet" type="text/css" href="../css/sap-icons.css"/>

# Configure an SAP CAP Application to Work with Native SAP HANA Artifacts

Configure SAP CAP applications to deploy native design-time database artifacts to an SAP HANA database.



<a name="loioef0377f5e9d84ce3aeb43a7e4baa5fe4__prereq_nfh_wtt_r4b"/>

## Prerequisites

For this tutorial, the following prerequisites apply:

-   You have access to an SAP HANA Cloud, SAP HANA database instance.
-   The SAP HANA database instance has been set up, started, and is available.



## Context

There are two ways to configure an SAP CAP application to use an SAP HANA database. You can either use the so-called "hybrid mode", where your services run locally but connect to a database running in the Cloud, or you can run your whole application in the Cloud, for example, on SAP Business Technology Platform.

SAP CAP enables you to use CAP Core Data Services \(CDS\) to create design-time database tables and SQL views for your application. But you can also include **native** SAP HANA design-time database artifacts in your application, for example: tables \(`hdbtable`\), SQL views \(`hdbview`\), calculation views \(`hdbcalculationview`\), procedures \(`hdbprocedure`\), indexes \(`hdbindex`\), synonyms \(`hdbsynonym`\) and so on. CAP even allows you to to mix both CDS artifacts and native SAP HANA artifacts in the same application project.

> ### Note:  
> SAP CAP CDS is similar to, but not the same as, SAP HANA CDS. SAP HANA CDS is not supported in SAP HANA Cloud.

To enable the use of native SAP HANA database artifacts in your SAP CAP application, you need to configure the application to convert SAP CAP CDS artifacts \(tables and SQL views\) to the native SAP HANA format \(`hdb*`\) when you build and deploy the application, as described in this tutorial. Any additional native SAP HANA database artifacts in the project \(for example, in the folder `/db/src`\) are picked up and used in their original format.



## Procedure

1.  Enhance an existing CAP project configuration to enable deployment to an SAP HANA database.

    > ### Tip:  
    > If you check the option *Configuration for SAP HANA Development* during creating of a new SAP CAP project, the configuration changes described in this step are made for you automatically.

    1.  Configure an SAP CAP **Node.js** application to use SAP HANA as the underlying database type and deployment target.

        The following code shows how to modify the `package.json` file located in the root directory of the SAP CAP Node.js application to set the target database for deployment to SAP HANA and ensure that the deployment format is the native SAP HANA HDI default \(`hdbtable`, `hdbview`, `hdb*`, etc\). The `.hdbtable` and `.hdbview` files generated by the conversion from CDS are written to the folder `db/src/gen`. Any existing native SAP HANA database artifacts \(for example, in `db/src`\) are left unchanged but included in the deployment.

        > ### Sample Code:  
        > <code>/<i class="varname">&lt;myApp&gt;</i>/package.json</code>
        > 
        > ```json
        > {
        >   "cds": {
        >       "build": { 
        >        "target": "." 
        >       }, 
        >       "requires": { 
        >           "db": { 
        >               "kind": "sql" 
        >           } 
        >       },
        >       "hana" : { 
        >           "deploy-format": "hdbtable" 
        >       }
        >   }
        > }
        > ```

        To enable the Node.js run time to connect to an SAP HANA database instance, add the `@sap/hana-client` module as a dependency to your SAP CAP Node.js project, as illustrated in the following example:

        > ### Sample Code:  
        > ```
        > npm add @sap/hana-client --save
        > ```

    2.  Configure an SAP CAP **Java** application to use SAP HANA as the underlying database type and deployment target.

        For SAP CAP Java applications, you do not modify the `package.json` file. Instead, you add the following details to the `.cdsrc.json` configuration file in the application' s root folder:

        > ### Sample Code:  
        > <code>/<i class="varname">&lt;myApp&gt;</i>/.cdsrc.json</code>
        > 
        > ```
        > {
        >    "build": { 
        >        "target": "." 
        >    }, 
        >    "requires": { 
        >        "db": { 
        >            "kind": "sql" 
        >        } 
        >    },
        >    "hana" : { 
        >        "deploy-format": "hdbtable" 
        >    }
        > }
        > ```


2.  Use native SAP HANA database objects in SAP CAP CDS.

    You can configure your SAP CAP CDS project to use native SAP HANA database artifacts. For all database artifacts that cannot be modeled with SAP CAP CDS, you can create a new \(or use an existing\) native SAP HANA database object and make use of it in your SAP CAP CDS model. But you can also use native SAP HANA artifacts that **can** be modeled in SAP CAP CDS, for example: tables, SQL views, and calculation views.

    > ### Note:  
    > For existing native SAP HANA artifacts, however, you need to define a mirror \(so-called "facade"\) artifact in SAP CAP CDS, as explained below; the facade artifact has the same name \(and elements\) as the corresponding, native SAP HANA artifact and acts as a proxy representing the signature of the underlying SAP HANA artifact.

    1.  Create new \(or use existing\) native SAP HANA database artifacts.

        When adding native SAP HANA design-time artifacts to your SAP CAP application project \(for example, `.hdbtable`, `.hdbview`, or `.hdbsynonym` files\), make sure you save them in the `db/src` folder of your SAP CAP CDS application project. During the build process, this folder stays untouched; the contents are simply copied to the `gen/db/src` folder.

        > ### Tip:  
        > Use this approach for all artifacts that cannot be modeled using SAP CAP CDS.

    2.  Make the new \(or existing\) native SAP HANA artifact known to SAP CAP CDS.

        If you plan to use native SAP HANA tables, SQL views, user-defined functions, or calculation views in your SAP CAP data model, it is necessary to let SAP CAP CDS know about these existing artifacts, for example, by using the annotation "`@cds.persistence.exists`". The annotation must be added to a mirror \(aka "facade"\) artifact that is defined in SAP CAP CDS to inform SAP CAP CDS that the database object already exists in the form of an SAP HANA design-time artifact. Since the database object exists, it is possible to make an association between the two database objects: the SAP CAP CDS mirror artifact and the underlying native SAP HANA object.

        > ### Tip:  
        > For more details about querying such proxy artifacts as well as how associations to proxy artifacts are handled, see *Using Native SAP HANA Artifacts with SAP CAP CDS \(SAP CAP Advanced\)* in *Related Information* below.

        The following SAP CDS facade artifact is used to represent an underlying native SAP HANA table with a **plain** name: a name that does not include either a name space or any incompatible characters:

        > ### Sample Code:  
        > Native SAP HANA Artifact: `/db/src/existing-table-without-params-plain.hdbtable`
        > 
        > ```
        > COLUMN TABLE DATA_MODEL_BOOKSHOP_BOOKS ( 
        >   ID integer, 
        >   THE_TITLE nvarchar(100), 
        >   primary key ( ID ) 
        > ) 
        > ```

        > ### Sample Code:  
        > SAP CDS Artifact: `/db/src/mirror-cds-entity-without-params.cds`
        > 
        > ```
        > namespace data.model; 
        > 
        > context Bookshop { 
        >   @cds.persistence.exists 
        >   entity Books { 
        >     key id : Integer; 
        >     the_title : String(100); 
        >   } 
        > }
        > ```

        > ### Note:  
        > If the full name of the existing native SAP HANA table \(including the name space and path separators\) contains special characters, for example, a "." \(dot\), " or a "::" \(double semi-colon\), then an additional synonym is required to complete the mapping process between the native SAP HANA entity and its mirror CAP CDS entity. For more information, see *Using Native SAP HANA Artifacts with SAP CAP CDS \(SAP CAP Advanced\)* in *Related Information* below.

        For calculation views and user-defined functions, similar additional annotations are required, for example, "`@cds.persistence.calcview`" and "`@cds.persistence.udf`", as illustrated in the following example:

        > ### Sample Code:  
        > Native SAP HANA Artifact: `/db/src/mapping-calc-view.hdbview`
        > 
        > ```
        > CREATE VIEW WeUseAddressCalcView AS SELECT 
        >   AddressCalcView_0.id 
        > FROM AddressCalcView(PLACEHOLDER."$$USERID$$" => 4711) AS AddressCalcView_0;
        > CREATE VIEW WeUseAddressUDF AS SELECT 
        >   AddressUDF_0.id 
        > FROM AddressUDF() AS AddressUDF_0; 
        > ```

        > ### Sample Code:  
        > SAP CDS Artifact: `/db/src/mirror-cds-entity-existing-calc-view.cds`
        > 
        > ```
        > @cds.persistence.exists 
        > @cds.persistence.calcview 
        > entity AddressCalcView (USERID: Integer) { 
        >     key id: Integer; 
        > }; 
        > 
        > view WeUseAddressCalcView as select from AddressCalcView(USERID: 4711); 
        > 
        > @cds.persistence.exists 
        > @cds.persistence.udf 
        > entity AddressUDF { 
        >     key id: Integer; 
        > }; 
        > 
        > view WeUseAddressUDF as select from AddressUDF;
        > ```

        Bear in mind that the mirror \(or facade\) artifact is only needed to enable access to the underlying native SAP HANA object from SAP CAP CDS; the facade artifact has nothing to do with the deployment of the original SAP HANA object. However, if you want to layer an SAP CAP view on top of the object or expose it as part of an SAP CAP service layer, then you need the facade object.

        > ### Note:  
        > You can also use facade objects for synonyms. Procedures and functions, however, require a different approach, where you use an exit handler \(rather than a facade object\) to implement them. For more information, see the *Combine SAP CAP with Native SAP HANA Cloud Artifacts in a Full-Stack Applications \(Tutorial\)* in *Related Information* below.


3.  Deploy the SAP CAP application.

    You deploy SAP CAP applications using SAP Web IDE Full-stack or alternatively the `cds` command-line interface \(CLI\), as follows:

    -   Graphical User Interface:

        In SAP Business Application Studio, open the *SAP HANA Projects* pane, select the project you want to deploy, for example, `sapcapjava1`, and choose: <span class="FPA-icons-V3">î›£</span> \(Deploy\). The progress of the deployment is displayed in the *Terminal*.

    -   Command-line Interface:

        In SAP Business Application Studio's, open the terminal \(*Terminal* \> *New Terminal* \), and run the following `cds` command:

        ```
        cds deploy --to hana
        ```


    > ### Tip:  
    > SAP CAP calls the standard HDI deployer \(`@sap/hdi-deploy`\) to deploy database artifacts to SAP HANA. This includes any table and view artifacts converted to the native SAP HANA format by CAP CDS \(and placed in the `db/src/gen` folder\) as well as any other native SAP HANA HDI artifacts located in the `db/src` folder.

4.  Load initial data into your SAP HANA database tables.

    Table data stored in CSV files in your project are tagged for deployment to both SQLite and SAP HANA. Before deployment, the CSV files are converted to the HDI `.hdtabledata` format required by SAP HANA. If your SAP CAP application uses CSV files to load data into SAP HANA \(HDI\) tables, bear in mind the following prerequisites:

    -   The CSV files containing the table data must be located in one of the following folders of your SAP CAP application project:

        -   `db/csv`

        -   `db/data/`

        -   `db/src/csv`


    -   Each CSV file must only contain data for one table \(entity\).

    -   The CSV file name must use the following pattern:

        -   Normal entity:

            <code><i class="varname">&lt;namespace&gt;</i>-<i class="varname">&lt;entity&gt;</i>.csv</code>

            `my.bookshop-Books.csv`

        -   Nested entity:

            <code><i class="varname">&lt;namespace&gt;</i>-<i class="varname">&lt;entity&gt;</i>.<i class="varname">&lt;nestedEntity&gt;</i>.csv</code>

            `my.bookshop-Books.ISBN.csv`


    -   Each CSV file must start with a header line that lists the required element names.


    > ### Note:  
    > For deployments to SAP HANA, it is important only to use CSV files for configuration data that cannot be changed by application users. This is because CSV files are deployed as `hdbtabledata` artifacts, SAP HANA assumes exclusive ownership of the data, and the data are overwritten with the next application deployment. For more information about resolving problems related to sample data, for example, by using an `undeploy.json` file, see *Troubleshooting* in *Related Information* below.


**Related Information**  


[Using Databases \(SAP CAP Cookbook\)](https://cap.cloud.sap/docs/guides/databases#get-hana)

[Using Native SAP HANA Artifacts with SAP CAP CDS \(SAP CAP Advanced\)](https://cap.cloud.sap/docs/advanced/hana)

[Design-time Content Compatibility \(SAP HANA Cloud Migration Guide\)](https://help.sap.com/viewer/DRAFT/3c53bc7b58934a9795b6dd8c7e28cf05/hanacloud/en-US/9c8656d9c1a34c829fab426cb77b4639.html)

[Use SAP HANA as the Database for an SAP CAP Java Application \(Tutorial\)](https://developers.sap.com/tutorials/cp-cap-java-hana-db.html#880cf07a-1788-4fda-b6dd-b5a6e5259625)

[Loading Initial Data into SAP HANA Tables from CSV Files \(SAP CAP Cookbook\)](https://cap.cloud.sap/docs/guides/databases#providing-initial-data)

[Troubleshooting SAP HANA CSV Data \(SAP CAP Cookbook\)](https://cap.cloud.sap/docs/advanced/troubleshooting#hana-csv)

[Combine SAP CAP with Native SAP HANA Cloud Artifacts in a Full-Stack Applications \(Tutorial\)](https://developers.sap.com/mission.hana-cloud-cap.html)

